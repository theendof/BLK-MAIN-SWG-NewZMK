# Бранч true-dual-scroll

## Описание
Экспериментальная ветка прошивки ZMK для **Charybdis 4x6** на базе **nice_nano (nRF52840)** с трекболом **PMW3610** и **правильной обработкой input processors** с **двумя режимами скролла**.

## Ключевые особенности

### ZMK и Zephyr
- **ZMK**: актуальная **main** ветка (rolling release)
- **Zephyr**: версия **4.1**
- Переход с `nice_nano_v2` на `nice_nano` в связи с изменениями в Zephyr 4.1

### Аппаратная конфигурация
- **Плата**: nice_nano (ProMicro nRF52840)
- **Раскладка**: Charybdis 4x6 (сплит-клавиатура)
- **Трекбол**: PMW3610 (драйвер от badjeff, ревизия **zmk-0.4**)
- **Интерфейс**: SPI (CS: P0.20, SCK: P0.08, MOSI/MISO: P0.17, IRQ: P0.06)

### Настройки трекбола (PMW3610)
```
CPI: 1000
swap-xy: включен
invert-x: включен
invert-y: включен
force-awake: включен
Режим: INPUT_EV_REL (mouse movement)
```

### Режимы работы трекбола (input processors)

**Порядок обработки важен!** Более специфичные режимы идут первыми:

#### 1. Снайперский режим (SNIPE layer) - слой 3
- **Обработка**: масштабирование **1:3** (замедление для точности)
- **Назначение**: точные операции, прицеливание

#### 2. Режим мыши (AUTO_MOUSE layer) - слой 2
- **Обработка**: масштабирование **1:1** (нативная скорость сенсора)
- **Назначение**: стандартное перемещение курсора без ускорения

#### 3. Скролл медленный (NUM_AND_FUN layer) - слой 1
- **Обработка**: 
  - Инверсия Y-оси
  - Масштабирование **1:120** (в 3 раза медленнее)
  - Конвертация в события прокрутки
- **Назначение**: точная прокрутка для работы с таблицами и кодом

#### 4. Скролл обычный (QWERTY layer) - слой 0
- **Обработка**: 
  - Инверсия Y-оси
  - Масштабирование **1:40**
  - Конвертация в события прокрутки
- **Назначение**: быстрая прокрутка документов на базовом слое

### Архитектура
- Shield-based конфигурация (`charybdis_left`, `charybdis_right`)
- `input-listener` с `CHARYBDIS_TRACKBALL_PROCESSORS` макросом
- Модульная структура с отдельными файлами:
  - `charybdis_layers.h` - определения слоёв
  - `charybdis_trackball_processors.dtsi` - конфигурация обработки ввода с правильным порядком

### Bluetooth оптимизация
- `CONFIG_BT_BUF_EVT_RX_COUNT=40` - увеличенный буфер для стабильной связи

## История изменений

### 01.02.2026 - Снижена скорость мыши на AUTO_MOUSE
- Изменен масштаб с **3:2** (1.5x ускорение) на **1:1** (нативная скорость)
- Теперь курсор двигается с нативной скоростью сенсора (CPI 1000)
- Более контролируемое перемещение курсора

### 01.02.2026 - Исправлен порядок обработки input processors
- Исправлена проблема с fallback на неправильные режимы на слоях 1 и 2
- Новый порядок: **snipe → move → scroll_slow → scroll**
- Более специфичные режимы теперь проверяются первыми
- Теперь на NUM_AND_FUN (1) работает медленный скролл, на AUTO_MOUSE (2) - мышь

### 01.02.2026 - Создана конфигурация dual scroll modes
- Скролл обычный (QWERTY, слой 0): масштаб 1:40 - быстрая прокрутка
- Скролл медленный (NUM_AND_FUN, слой 1): масштаб 1:120 - точная прокрутка (в 3 раза медленнее)
- Режим мыши (AUTO_MOUSE, слой 2): масштаб 3:2 - ускорение курсора
- Снайперский режим (SNIPE, слой 3): масштаб 1:3 - замедление для точности

### 31.01.2026 - Добавлены input processors для трекбола
- Создан файл `charybdis_layers.h` с определениями слоёв
- Создан файл `charybdis_trackball_processors.dtsi` с конфигурацией обработки трекбола
- Обновлён `charybdis_right.overlay` для использования input processors
- Обновлён `west.yml`: драйвер PMW3610 переведён на ревизию `zmk-0.4`

### Предыдущие изменения
1. Обновление на ZMK main (Zephyr 4.1)
2. Фикс имени платы: `nice_nano_v2` → `nice_nano`
3. Увеличение BT буфера: `CONFIG_BT_BUF_EVT_RX_COUNT=40`
4. Коррекция направления трекбола: добавлен `invert-x`

## Для чего этот бранч
Тестирование правильной обработки трекбола с:
- **Двумя независимыми режимами скролла** (быстрый на QWERTY, медленный на NUM_AND_FUN)
- **Нативной скоростью курсора** на AUTO_MOUSE (1:1, без масштабирования)
- **Правильным порядком обработки** (snipe → move → scroll_slow → scroll)
- Четырьмя независимыми режимами на разных слоях
- Оптимальной настройкой для разных сценариев использования

## Важные ссылки
- [ZMK Firmware](https://github.com/zmkfirmware/zmk)
- [PMW3610 Driver by badjeff](https://github.com/badjeff/zmk-pmw3610-driver)
- [Build workflow](.github/workflows/)

## Предупреждение
⚠️ **Экспериментальный бранч!** Main ветка ZMK может содержать нестабильные изменения. Для production используйте фиксированные версии ZMK.

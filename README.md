# КОНФИГУРАЦИЯ ZMK ДЛЯ CHARYBDIS 4X6 WIRELESS (ZEPHYR 4.1)

Экспериментальная прошивка ZMK для беспроводной сплит-клавиатуры **Charybdis 4x6** с трекболом **PMW3610** и продвинутой обработкой режимов трекбола.

## Содержание

- [Особенности прошивки](#особенности-прошивки)
- [Аппаратная конфигурация](#аппаратная-конфигурация)
- [Структура репозитория](#структура-репозитория)
- [Режимы работы трекбола](#режимы-работы-трекбола)
- [West.yml конфигурация](#westyml-конфигурация)
- [GitHub Actions конфигурация](#github-actions-конфигурация)
- [Визуализация раскладки](#визуализация-раскладки)
- [Настройка чувствительности трекбола](#настройка-чувствительности-трекбола)
- [Сборка прошивки](#сборка-прошивки)
- [Прошивка устройств](#прошивка-устройств)
- [История изменений](#история-изменений)

## Особенности прошивки

### ZMK и Zephyr
- **ZMK**: актуальная **main** ветка (rolling release)
- **Zephyr**: версия **4.1**
- Переход с `nice_nano_v2` на `nice_nano` в связи с изменениями в Zephyr 4.1

### Ключевые возможности
- **Два независимых режима скролла** (быстрый и медленный) на разных слоях
- **Автоматическая генерация визуализации раскладки** в формате SVG при каждой сборке
- **Визуализация включается в артефакт** вместе с файлами прошивки
- **Оптимизированный Bluetooth** буфер для стабильной связи

## Аппаратная конфигурация

### Компоненты
- **Плата контроллера**: nice_nano (ProMicro nRF52840)
- **Раскладка**: Charybdis 4x6 (сплит-клавиатура)
- **Трекбол**: PMW3610 (драйвер от badjeff, ревизия **zmk-0.4**)
- **Интерфейс трекбола**: SPI

### Пины подключения

#### Клавишная матрица (обе половины)

**Занятые пины:**

Строки (rows, общие):
- **P0.31** - Row 0
- **P1.15** - Row 1
- **P0.24** - Row 2
- **P0.22** - Row 3
- **P1.6** - Row 4

Колонки (columns, каждая половина):
- **P0.2** - Col 0
- **P0.29** - Col 1
- **P0.9** - Col 2
- **P1.0** - Col 3
- **P0.11** - Col 4
- **P1.4** - Col 5

#### Трекбол PMW3610 (только правая половина)

**Занятые пины:**
- **P0.8** - SPI SCK
- **P0.17** - SPI MOSI/MISO
- **P0.20** - SPI CS
- **P0.6** - IRQ

**Итого занято на правой половине:** 15 пинов (5 rows + 6 cols + 4 trackball)

**Итого занято на левой половине:** 11 пинов (5 rows + 6 cols)

#### Свободные пины

**На правой половине:**
- P0.10, P0.30, P1.13, P1.11, P0.3, P0.28

**На левой половине:**
- P0.6, P0.8, P0.17, P0.20, P0.10, P0.30, P1.13, P1.11, P0.3, P0.28

## Структура репозитория

```text
WHT-MAIN-SWG-based-on-ch-4-6-wl/
├── .github/workflows/
│   ├── main.yml                              # Основной workflow сборки
│   └── draw_keymaps.yaml                     # Генерация SVG визуализации
├── boards/shields/charybdis/
│   ├── charybdis_layers.h                    # Определения слоёв
│   ├── charybdis_trackball_processors.dtsi   # Конфигурация input processors
│   ├── charybdis_left.overlay                # Конфигурация левой половины
│   ├── charybdis_right.overlay               # Конфигурация правой половины с трекболом
│   └── ...
├── config/
│   ├── charybdis.keymap                      # Раскладка клавиатуры
│   ├── charybdis.conf                        # Глобальная конфигурация ZMK
│   └── west.yml                              # Манифест зависимостей
├── keymap-drawer/
│   ├── charybdis.svg                         # Автоматически сгенерированная визуализация
│   └── charybdis.yaml                        # YAML представление раскладки
└── README.md                                 # Этот файл
```

### Ключевые файлы

- **`charybdis_layers.h`**: Определения слоёв (QWERTY, NUM_AND_FUN, AUTO_MOUSE, SNIPE)
- **`charybdis_trackball_processors.dtsi`**: Обработка ввода трекбола с правильным порядком процессоров
- **`charybdis_right.overlay`**: Аппаратная конфигурация правой половины (GPIO, SPI, трекбол)
- **`config/west.yml`**: Зависимости прошивки (ZMK, драйверы)

## Режимы работы трекбола

⚠️ **Порядок обработки критически важен!** Более специфичные режимы проверяются первыми.

### 1. Снайперский режим (SNIPE layer - слой 3)
- **Масштабирование**: 1:5 (замедление в 5 раз)
- **Назначение**: Точные операции, прицеливание
- **Применение**: Работа с мелкими элементами интерфейса

### 2. Режим мыши (AUTO_MOUSE layer - слой 2)
- **Масштабирование**: 2:3 (ускорение в 1.5 раза)
- **Назначение**: Стандартное перемещение курсора
- **Применение**: Обычная навигация с небольшим ускорением

### 3. Медленный скролл (NUM_AND_FUN layer - слой 1)
- **Масштабирование**: 1:240
- **Инверсия**: Y-ось инвертирована
- **Назначение**: Очень точная прокрутка
- **Применение**: Работа с таблицами, кодом, детальный просмотр

### 4. Быстрый скролл (QWERTY layer - слой 0)
- **Масштабирование**: 1:60
- **Инверсия**: Y-ось инвертирована
- **Назначение**: Быстрая прокрутка документов
- **Применение**: Просмотр длинных страниц, документов

## West.yml конфигурация

Файл `config/west.yml` определяет зависимости прошивки ZMK и внешние модули.

### Удалённые репозитории

```yaml
remotes:
  - name: zmkfirmware
    url-base: https://github.com/zmkfirmware
  - name: badjeff
    url-base: https://github.com/badjeff
```

- **zmkfirmware**: Основная прошивка ZMK
- **badjeff**: Драйвер трекбола PMW3610

### Зависимости

- **zmk**: Основная прошивка ZMK (ветка `main`)
- **zmk-pmw3610-driver**: Драйвер трекбола PMW3610 (ревизия `zmk-0.4`)
  - Источник: [badjeff/zmk-pmw3610-driver](https://github.com/badjeff/zmk-pmw3610-driver)
  - Поддержка Zephyr 4.1
  - Полная конфигурация input processors

## GitHub Actions конфигурация

Файл `.github/workflows/main.yml` определяет автоматическую сборку прошивки при каждом push.

### Процесс сборки

```yaml
jobs:
  keymap_images:
    permissions:
      contents: write
    uses: ./.github/workflows/draw_keymaps.yaml
    with:
      destination: 'both'
      artifact_name: 'keymap_raw_files'
    
  build:
    needs: keymap_images
    uses: zmkfirmware/zmk/.github/workflows/build-user-config.yml@main
    with:
      archive_name: firmware_WHT
      
  package_with_keymap:
    needs: [build, keymap_images]
    runs-on: ubuntu-latest
    # Создание финального артефакта firmware_WHT_SVG
```

### Этапы

1. **keymap_images**: Генерация SVG-визуализации раскладки из `config/charybdis.keymap`
2. **build**: Сборка файлов `.uf2` для обеих половин клавиатуры
3. **package_with_keymap**: Объединение прошивки и визуализации в один артефакт

### Результат

Артефакт `firmware_WHT_SVG` содержит:
- `charybdis_left-nice_nano-zmk.uf2`
- `charybdis_right-nice_nano-zmk.uf2`
- `settings_reset-nice_nano-zmk.uf2`
- `charybdis.svg` - визуализация раскладки

## Визуализация раскладки

Визуализация автоматически генерируется из файла `config/charybdis.keymap` с помощью [Keymap Drawer](https://github.com/caksoylar/keymap-drawer) при каждой сборке.

![Charybdis Keymap](https://raw.githubusercontent.com/KozZzi-ru/WHT-MAIN-SWG-based-on-ch-4-6-wl/READY_zmk4_Badjeff_true-dual-scroll/keymap-drawer/charybdis.svg)

Визуализация также доступна в репозитории: [keymap-drawer/charybdis.svg](https://github.com/KozZzi-ru/WHT-MAIN-SWG-based-on-ch-4-6-wl/blob/READY_zmk4_Badjeff_true-dual-scroll/keymap-drawer/charybdis.svg)

## Настройка чувствительности трекбола

### Аппаратная чувствительность (CPI)

Настраивается в файле `charybdis_right.overlay`:

```dts
trackball: trackball@0 {
    compatible = "pixart,pmw3610";
    cpi = <1600>;  // Измени это значение
};
```

**Рекомендуемые значения CPI:**
- `400` - Низкая чувствительность
- `800` - Средняя чувствительность (по умолчанию)
- `1200` - Высокая чувствительность
- `1600` - Очень высокая чувствительность (текущая настройка)

### Программное масштабирование

Настраивается в `charybdis_trackball_processors.dtsi`:

```dts
// Обычное движение курсора
move {
    layers = <AUTO_MOUSE>;
    input-processors = <&zip_xy_scaler 2 3>;  // множитель делитель (ускорение 1.5x)
};

// Снайперский режим
snipe {
    layers = <SNIPE>;
    input-processors = <&zip_xy_scaler 1 5>;  // Скорость × 1/5 (замедление в 5 раз)
};

// Медленный скролл
scroll_slow {
    layers = <NUM_AND_FUN>;
    input-processors = <&zip_xy_scaler 1 240>;  // Очень медленная прокрутка
};

// Быстрый скролл
scroll {
    layers = <QWERTY>;
    input-processors = <&zip_xy_scaler 1 60>;  // Быстрая прокрутка
};
```

**Формула**: `выход = (вход × множитель) / делитель`

**Примеры настройки:**

| Цель | Изменение | Пример |
|------|-----------|--------|
| Ускорить курсор | Увеличить множитель | `2 3` → `3 3` |
| Замедлить курсор | Увеличить делитель | `2 3` → `2 4` |
| Ускорить скролл | Уменьшить делитель | `1 60` → `1 40` |
| Замедлить скролл | Увеличить делитель | `1 60` → `1 80` |

⚠️ **Важно**: Используй значения ≤ 16 для множителя и делителя во избежание переполнения.

## Сборка прошивки

### GitHub Actions (автоматически)

При каждом push в репозиторий автоматически запускается процесс сборки:

1. **Генерация визуализации раскладки**: Workflow `draw_keymaps.yaml` автоматически создаёт SVG-изображение твоей раскладки клавиатуры из файла `config/charybdis.keymap`

2. **Сборка прошивки**: Компилируются файлы `.uf2` для обеих половин клавиатуры

3. **Создание пакета**: Формируется финальный артефакт `firmware_WHT_SVG`, содержащий:
   - `charybdis_left-nice_nano-zmk.uf2` - прошивка левой половины
   - `charybdis_right-nice_nano-zmk.uf2` - прошивка правой половины
   - `settings_reset-nice_nano-zmk.uf2` - сброс настроек
   - `charybdis.svg` - визуализация раскладки клавиатуры

4. **Скачивание**: Открой вкладку Actions в репозитории → выбери последний успешный build → скачай артефакт `firmware_WHT_SVG`

Визуализация раскладки также автоматически коммитится в папку `keymap-drawer/` в репозитории.

## Прошивка устройств

### Процесс прошивки

1. Дважды нажми кнопку reset на плате (быстро, два раза подряд)
2. Плата появится как USB-накопитель с именем `NICENANO`
3. Скопируй соответствующий `.uf2` файл на этот накопитель
4. Плата автоматически перезагрузится с новой прошивкой

### Когда прошивать какие файлы

| Что изменил | Левая | Правая | Reset |
|-------------|-------|--------|-------|
| Настройки трекбола (CPI, скорость) | ❌ | ✅ | ❌ |
| Раскладка клавиш (keymap) | ✅ | ✅ | ❌ |
| Комбинации клавиш (combos) | ✅ | ✅ | ❌ |
| Обновление ZMK/Zephyr | ✅ | ✅ | ✅ |
| Проблемы с Bluetooth | ✅ | ✅ | ✅ |
| Первая прошивка | ✅ | ✅ | ✅ |
| Пины/аппаратная конфигурация трекбола | ❌ | ✅ | ❌ |
| Глобальные настройки (charybdis.conf) | ✅ | ✅ | ❌ |

## История изменений

### 01.02.2026 - Исправлены описания CPI и множителей в README
- CPI изменен с 1000 на **1600** (фактическое значение в прошивке)
- Снайперский режим: масштаб исправлен с 1:3 на **1:5**
- Режим мыши: масштаб исправлен с 1:1 на **2:3** (ускорение 1.5x)
- Медленный скролл: масштаб исправлен с 1:120 на **1:240**
- Быстрый скролл: масштаб исправлен с 1:40 на **1:60**

### 01.02.2026 - Обновлен README
- Добавлен раздел GitHub Actions с описанием автоматической генерации keymap
- Добавлена визуализация раскладки (SVG) и ссылка на файл в репозитории
- Добавлена детальная информация о занятых и свободных пинах контроллера
- Раздел "Когда прошивать какие файлы" сокращён до справочной таблицы

### 01.02.2026 - Снижена скорость мыши на AUTO_MOUSE
- Изменён масштаб с **3:2** (1.5x ускорение) на **1:1** (нативная скорость)
- Курсор теперь движется с нативной скоростью сенсора (CPI 1000)
- Более контролируемое перемещение курсора

### 01.02.2026 - Исправлен порядок обработки input processors
- Исправлена проблема с fallback на неправильные режимы на слоях 1 и 2
- Новый порядок: **snipe → move → scroll_slow → scroll**
- Более специфичные режимы теперь проверяются первыми
- Теперь на NUM_AND_FUN (1) работает медленный скролл, на AUTO_MOUSE (2) - мышь

### 01.02.2026 - Создана конфигурация dual scroll modes
- Скролл обычный (QWERTY, слой 0): масштаб 1:40 - быстрая прокрутка
- Скролл медленный (NUM_AND_FUN, слой 1): масштаб 1:120 - точная прокрутка (в 3 раза медленнее)
- Режим мыши (AUTO_MOUSE, слой 2): масштаб 3:2 - ускорение курсора
- Снайперский режим (SNIPE, слой 3): масштаб 1:3 - замедление для точности

### 31.01.2026 - Добавлены input processors для трекбола
- Создан файл `charybdis_layers.h` с определениями слоёв
- Создан файл `charybdis_trackball_processors.dtsi` с конфигурацией обработки трекбола
- Обновлён `charybdis_right.overlay` для использования input processors
- Обновлён `west.yml`: драйвер PMW3610 переведён на ревизию `zmk-0.4`

### Предыдущие изменения
- Обновление на ZMK main (Zephyr 4.1)
- Фикс имени платы: `nice_nano_v2` → `nice_nano`
- Увеличение BT буфера: `CONFIG_BT_BUF_EVT_RX_COUNT=40`
- Коррекция направления трекбола: добавлен `invert-x`

## Полезные ссылки

- [ZMK Firmware](https://github.com/zmkfirmware/zmk) - основная прошивка ZMK
- [PMW3610 Driver by badjeff](https://github.com/badjeff/zmk-pmw3610-driver) - драйвер трекбола PMW3610
- [ZMK Input Processors](https://zmk.dev/docs/keymaps/input-processors/scaler) - документация по обработке ввода
- [choovick/zmk-config-charybdis](https://github.com/choovick/zmk-config-charybdis) - референсная конфигурация Charybdis с донглом и OLED

## Предупреждение

⚠️ **Экспериментальная ветка!** Main ветка ZMK может содержать нестабильные изменения. Для production рекомендуется использовать фиксированные версии ZMK.

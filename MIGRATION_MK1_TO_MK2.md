# Инструкция по переключению прошивки с MK1 на MK2

## Краткая суть проблемы

У клавиатур MK1 (белая) и MK2 (черная) **разная распайка**:

- **Основная матрица** (Row 0-3): используют разные пины
- **Тамб кластер** (Row 4): используют смешанные пины

## Файлы которые нужно изменить

### 1. `config/boards/shields/charybdis/charybdis_left.overlay`

**Что меняется**: col-gpios (пины колонок)

### 2. `config/boards/shields/charybdis/charybdis.dtsi`

**Что меняется**: default_transform -> map (matrix transform)

### 3. `config/charybdis.keymap`

**ЧТО МЕНЯТЬ**: НЕ НУЖНО! Кеймап универсальный для обеих клавиатур.

---

## Сравнительная таблица распайки

### Col-gpios (8 колонок на каждую половину)

| Col | Пин MK1 | Пин MK2 | Использование MK1 | Использование MK2 |
|-----|---------|---------|----------------|----------------|
| 0   | P0.2    | P0.2    | Общая + Тамб    | Общая + Тамб    |
| 1   | P0.29   | P0.29   | Общая + Тамб    | Общая + Тамб    |
| 2   | P0.9    | P0.9    | Общая + Тамб    | Общая + Тамб    |
| 3   | **P1.0**    | P1.0    | **Основная + Тамб** | Не используется  |
| 4   | **P0.11**   | P0.11   | **Основная + Тамб** | Не используется  |
| 5   | P0.10   | **P0.10**   | Не используется  | **Основная + Тамб** |
| 6   | P1.13   | **P1.13**   | Не используется  | **Основная + Тамб** |
| 7   | P1.4    | P1.4    | Общая        | Общая        |

**Ключевое отличие**:
- MK1: использует Col 3-4 (P1.0, P0.11)
- MK2: использует Col 5-6 (P0.10, P1.13)

---

## 1. Изменения в charybdis_left.overlay

### MK1 (белая) - старые пины

```c
col-gpios
    = <&gpio0 2 GPIO_ACTIVE_HIGH>   // col 0
    , <&gpio0 29 GPIO_ACTIVE_HIGH>  // col 1
    , <&gpio0 9 GPIO_ACTIVE_HIGH>   // col 2
    , <&gpio1 0 GPIO_ACTIVE_HIGH>   // col 3 - СТАРАЯ MK1
    , <&gpio0 11 GPIO_ACTIVE_HIGH>  // col 4 - СТАРАЯ MK1
    , <&gpio0 10 GPIO_ACTIVE_HIGH>  // col 5
    , <&gpio1 13 GPIO_ACTIVE_HIGH>  // col 6
    , <&gpio1 4 GPIO_ACTIVE_HIGH>   // col 7
    ;
```

### MK2 (черная) - новые пины

```c
col-gpios
    = <&gpio0 2 GPIO_ACTIVE_HIGH>   // col 0
    , <&gpio0 29 GPIO_ACTIVE_HIGH>  // col 1
    , <&gpio0 9 GPIO_ACTIVE_HIGH>   // col 2
    , <&gpio1 0 GPIO_ACTIVE_HIGH>   // col 3 - не используется
    , <&gpio0 11 GPIO_ACTIVE_HIGH>  // col 4 - не используется
    , <&gpio0 10 GPIO_ACTIVE_HIGH>  // col 5 - НОВАЯ MK2
    , <&gpio1 13 GPIO_ACTIVE_HIGH>  // col 6 - НОВАЯ MK2
    , <&gpio1 4 GPIO_ACTIVE_HIGH>   // col 7
    ;
```

**Вывод**: Пины одинаковые! Менять overlay **НЕ НУЖНО**.

---

## 2. Изменения в charybdis.dtsi (Matrix Transform)

### MK1 (белая) - старая распайка

```c
map = <
RC(0,0) RC(0,1) RC(0,2) RC(0,3) RC(0,4) RC(0,7)  RC(0,15) RC(0,14) RC(0,12) RC(0,11) RC(0,10) RC(0,8)
RC(1,0) RC(1,1) RC(1,2) RC(1,3) RC(1,4) RC(1,7)  RC(1,15) RC(1,14) RC(1,12) RC(1,11) RC(1,10) RC(1,8)
RC(2,0) RC(2,1) RC(2,2) RC(2,3) RC(2,4) RC(2,7)  RC(2,15) RC(2,14) RC(2,12) RC(2,11) RC(2,10) RC(2,8)
RC(3,0) RC(3,1) RC(3,2) RC(3,3) RC(3,4) RC(3,7)  RC(3,15) RC(3,14) RC(3,12) RC(3,11) RC(3,10) RC(3,8)
        RC(4,3) RC(4,4) RC(4,1) RC(4,7) RC(4,2)  RC(4,11) RC(4,10) RC(4,8)
>;
```

**MK1 основная матрица**: использует col 0,1,2,3,4,7  
**MK1 тамб кластер**:
- Левый: RC(4,3) RC(4,4) RC(4,1) RC(4,7) RC(4,2)
- Правый: RC(4,11) RC(4,10) RC(4,8)

### MK2 (черная) - новая распайка

```c
map = <
RC(0,0) RC(0,1) RC(0,2) RC(0,5) RC(0,6) RC(0,7)  RC(0,15) RC(0,14) RC(0,13) RC(0,10) RC(0,9) RC(0,8)
RC(1,0) RC(1,1) RC(1,2) RC(1,5) RC(1,6) RC(1,7)  RC(1,15) RC(1,14) RC(1,13) RC(1,10) RC(1,9) RC(1,8)
RC(2,0) RC(2,1) RC(2,2) RC(2,5) RC(2,6) RC(2,7)  RC(2,15) RC(2,14) RC(2,13) RC(2,10) RC(2,9) RC(2,8)
RC(3,0) RC(3,1) RC(3,2) RC(3,5) RC(3,6) RC(3,7)  RC(3,15) RC(3,14) RC(3,13) RC(3,10) RC(3,9) RC(3,8)
        RC(4,5) RC(4,0) RC(4,1) RC(4,6) RC(4,2)  RC(4,9) RC(4,8) RC(4,10)
>;
```

**MK2 основная матрица**: использует col 0,1,2,5,6,7  
**MK2 тамб кластер**:
- Левый: RC(4,5) RC(4,0) RC(4,1) RC(4,6) RC(4,2)
- Правый: RC(4,9) RC(4,8) RC(4,10)

---

## Сравнительная таблица Matrix Transform

### Основная матрица (Row 0-3)

| Позиция | MK1       | MK2       | Изменение |
|---------|-----------|-----------|------------|
| Col 4   | RC(x,3)   | RC(x,5)   | 3 → 5     |
| Col 5   | RC(x,4)   | RC(x,6)   | 4 → 6     |
| Col 7   | RC(x,12)  | RC(x,13)  | 12 → 13   |
| Col 8   | RC(x,11)  | RC(x,10)  | 11 → 10   |
| Col 9   | RC(x,10)  | RC(x,9)   | 10 → 9    |

### Тамб кластер (Row 4)

#### Левый тамб (5 клавиш)

| Клавиша | MK1     | MK2     | Физическая колонка |
|----------|---------|---------|-------------------|
| 1 (лев)   | RC(4,3) | RC(4,5) | Col 5 (P0.10)     |
| 2        | RC(4,4) | RC(4,0) | Col 0 (P0.2)      |
| 3 (центр) | RC(4,1) | RC(4,1) | Col 1 (P0.29)     |
| 4        | RC(4,7) | RC(4,6) | Col 6 (P1.13)     |
| 5 (прав)  | RC(4,2) | RC(4,2) | Col 2 (P0.9)      |

#### Правый тамб (3 клавиши)

| Клавиша | MK1      | MK2     | Физическая колонка |
|----------|----------|---------|-------------------|
| 6 (лев)   | RC(4,11) | RC(4,9) | Col 1 (P0.29)     |
| 7 (центр) | RC(4,10) | RC(4,8) | Col 0 (P0.2)      |
| 8 (прав)  | RC(4,8)  | RC(4,10)| Col 2 (P0.9)      |

---

## Алгоритм переключения MK1 → MK2

### Шаг 1: Открой `config/boards/shields/charybdis/charybdis.dtsi`

### Шаг 2: Найди секцию `default_transform`

### Шаг 3: Замени всю секцию `map` на:

#### Для MK1:
```c
map = <
RC(0,0) RC(0,1) RC(0,2) RC(0,3) RC(0,4) RC(0,7)  RC(0,15) RC(0,14) RC(0,12) RC(0,11) RC(0,10) RC(0,8)
RC(1,0) RC(1,1) RC(1,2) RC(1,3) RC(1,4) RC(1,7)  RC(1,15) RC(1,14) RC(1,12) RC(1,11) RC(1,10) RC(1,8)
RC(2,0) RC(2,1) RC(2,2) RC(2,3) RC(2,4) RC(2,7)  RC(2,15) RC(2,14) RC(2,12) RC(2,11) RC(2,10) RC(2,8)
RC(3,0) RC(3,1) RC(3,2) RC(3,3) RC(3,4) RC(3,7)  RC(3,15) RC(3,14) RC(3,12) RC(3,11) RC(3,10) RC(3,8)
        RC(4,3) RC(4,4) RC(4,1) RC(4,7) RC(4,2)  RC(4,11) RC(4,10) RC(4,8)
>;
```

#### Для MK2:
```c
map = <
RC(0,0) RC(0,1) RC(0,2) RC(0,5) RC(0,6) RC(0,7)  RC(0,15) RC(0,14) RC(0,13) RC(0,10) RC(0,9) RC(0,8)
RC(1,0) RC(1,1) RC(1,2) RC(1,5) RC(1,6) RC(1,7)  RC(1,15) RC(1,14) RC(1,13) RC(1,10) RC(1,9) RC(1,8)
RC(2,0) RC(2,1) RC(2,2) RC(2,5) RC(2,6) RC(2,7)  RC(2,15) RC(2,14) RC(2,13) RC(2,10) RC(2,9) RC(2,8)
RC(3,0) RC(3,1) RC(3,2) RC(3,5) RC(3,6) RC(3,7)  RC(3,15) RC(3,14) RC(3,13) RC(3,10) RC(3,9) RC(3,8)
        RC(4,5) RC(4,0) RC(4,1) RC(4,6) RC(4,2)  RC(4,9) RC(4,8) RC(4,10)
>;
```

### Шаг 4: Сохрани файл

### Шаг 5: Закоммить изменения в git

```bash
git add config/boards/shields/charybdis/charybdis.dtsi
git commit -m "Switch to MK2 matrix transform"
git push
```

---

## Quick Reference: Что менять

| Файл | MK1 → MK2 | Что изменяется |
|-------|-----------|------------------|
| `charybdis_left.overlay` | НЕ МЕНЯТЬ | - |
| `charybdis_right.overlay` | НЕ МЕНЯТЬ | - |
| `charybdis.dtsi` | МЕНЯТЬ | Matrix transform (map) |
| `charybdis.keymap` | НЕ МЕНЯТЬ | - |

---

## Ключевые отличия по цифрам

### Основная матрица (Row 0-3)

```
MK1: 3, 4 → MK2: 5, 6
```

### Левый тамб (5 клавиш)

```
MK1: 3, 4, 1, 7, 2
MK2: 5, 0, 1, 6, 2

Изменения: 3→5, 4→0, 7→6
```

### Правый тамб (3 клавиши)

```
MK1: 11, 10, 8
MK2: 9, 8, 10

Изменения: 11→9, 10→8, 8→10
```

---

## Проверка правильности

После прошивки проверь:

1. ✅ Все клавиши основной матрицы работают
2. ✅ 5 клавиш левого тамба работают
3. ✅ 3 клавиши правого тамба работают
4. ✅ Трекбол работает

---

## История решения проблемы

**Дата**: 08.02.2026

**Проблема**: Не работали клавиши тамб кластера на MK2

**Причина**: Разная распайка MK1 и MK2

**Решение**:
1. Проведена диагностика с тестовой прошивкой
2. Выявлены реальные колонки для каждой клавиши
3. Создан правильный matrix transform для MK2
4. Все 8 клавиш тамб кластера теперь работают! ✅
